---
- name: Space API Example - Get Jobs
  hosts: all
  connection: local
  gather_facts: no

  vars:
    space_api_uri: "https://{{ ansible_host }}:{{ space_api_port }}/api"
    space_api_login_uri : "space/user-management/login"
    ssl_verification: no

  tasks:
    - name: Login to Junos Space
      uri:
        url: "{{ space_api_uri }}/{{ space_api_login_uri }}"
        method: POST
        validate_certs: "{{ ssl_verification }}"
        status_code: 200
        return_content: yes
        force_basic_auth: yes
        user: "{{ space_auth_user }}"
        password: "{{ space_auth_password }}"
        headers:
          Accept: application/vnd.net.juniper.space.user-management.user-ref+json;version=1
      register: response

    - name: Print login results
      debug:
        var: response.json
        verbosity: 1

    - set_fact:
        loginfacts: "{{ response }}" # quotes are required or will fail

    - name: Get JOB List
      uri:
        url: "{{ space_api_uri }}/space/job-management/jobs/229410"
        method: GET
        follow_redirects: all
        return_content: yes
        headers:
          Accept: application/vnd.net.juniper.space.job-management.job+json;version=3
          Cookie: "{{ loginfacts.set_cookie }}"
        validate_certs:  "{{ ssl_verification }}"
      register: response
      until: response.json.job["job-state"] == "DONE"
      retries: 5
      delay: 10

    - name: print response
      debug:
        var: response.json
        verbosity: 1

    - name: Logout from Junos Space
      uri:
        url: "{{ space_api_uri }}/space/user-management/logout"
        method: POST
        status_code: 200
        validate_certs: "{{ ssl_verification }}"
        headers:
          Cookie: "{{ login.set_cookie }}"
